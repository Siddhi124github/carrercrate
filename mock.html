<script>
    // Mobile menu functionality
    const menuToggle = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (menuToggle && mobileMenu) {
        menuToggle.addEventListener('click', function() {
            mobileMenu.classList.toggle('open');
            // Toggle hamburger icon
            const icon = this.querySelector('i');
            if (mobileMenu.classList.contains('open')) {
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        });
        
        // Close mobile menu when clicking on a link
        document.querySelectorAll('.mobile-menu a').forEach(link => {
            link.addEventListener('click', function() {
                mobileMenu.classList.remove('open');
                menuToggle.querySelector('i').classList.remove('fa-times');
                menuToggle.querySelector('i').classList.add('fa-bars');
            });
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (mobileMenu && mobileMenu.classList.contains('open') && 
                !menuToggle.contains(event.target) && 
                !mobileMenu.contains(event.target)) {
                mobileMenu.classList.remove('open');
                menuToggle.querySelector('i').classList.remove('fa-times');
                menuToggle.querySelector('i').classList.add('fa-bars');
            }
        });
    }

    const API_BASE_URL = window.location.origin.includes('5500') 
        ? 'http://localhost:3001' 
        : window.location.origin;
    
    const interviewState = {
        sessionId: null,
        questionCount: 0,
        maxQuestions: 10,
        currentStage: 'basic',
        stages: ['basic', 'role', 'technical', 'resume', 'behavioral', 'salary'],
        interviewMode: 'text',
        isRecording: false,
        recognition: null,
        currentTranscript: '',
        currentAudio: null,
        isSpeaking: false
    };

    // DOM elements
    const setupScreen = document.getElementById('setupScreen');
    const interviewScreen = document.getElementById('interviewScreen');
    const feedbackScreen = document.getElementById('feedbackScreen');
    const jobRoleInput = document.getElementById('jobRole');
    const resumeTextArea = document.getElementById('resumeText');
    const chatContainer = document.getElementById('chatContainer');
    const userAnswer = document.getElementById('userAnswer');
    const submitBtn = document.getElementById('submitBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const feedbackContent = document.getElementById('feedbackContent');
    const stageIndicator = document.getElementById('stageIndicator');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');
    const setupError = document.getElementById('setupError');
    const interviewError = document.getElementById('interviewError');
    const feedbackJobRole = document.getElementById('feedbackJobRole');
    const feedbackQuestionCount = document.getElementById('feedbackQuestionCount');
    const interviewDate = document.getElementById('interviewDate');
    const interviewMode = document.getElementById('interviewMode');
    const interviewerAvatar = document.getElementById('interviewerAvatar');
    const avatarSection = document.getElementById('avatarSection');
    const interviewInfo = document.getElementById('interviewInfo');
    const feedbackActions = document.getElementById('feedbackActions');
    
    // Voice elements
    const voiceControls = document.getElementById('voiceControls');
    const textControls = document.getElementById('textControls');
    const recordBtn = document.getElementById('recordBtn');
    const submitVoiceBtn = document.getElementById('submitVoiceBtn');
    const voiceStatus = document.getElementById('voiceStatus');
    const transcriptDisplay = document.getElementById('transcriptDisplay');
    const voiceVisualizer = document.getElementById('voiceVisualizer');

    const stageLabels = {
        'basic': 'Professional Background',
        'role': 'Role-specific Questions', 
        'technical': 'Technical Assessment',
        'resume': 'Experience Review',
        'behavioral': 'Behavioral Analysis',
        'salary': 'Compensation Discussion'
    };

    // Initialize audio visualizer bars
    function initVisualizer() {
        voiceVisualizer.innerHTML = '';
        for (let i = 0; i < 40; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.height = '2px';
            voiceVisualizer.appendChild(bar);
        }
    }

    // Update visualizer based on audio level
    function updateVisualizer(level) {
        const bars = voiceVisualizer.getElementsByClassName('bar');
        const activeBars = Math.floor((level / 100) * bars.length);
        
        for (let i = 0; i < bars.length; i++) {
            if (i < activeBars) {
                const height = 2 + (i * 2);
                bars[i].style.height = `${height}px`;
                bars[i].style.background = `hsl(${210 + (i * 2)}, 100%, 50%)`;
            } else {
                bars[i].style.height = '2px';
                bars[i].style.background = 'var(--primary)';
            }
        }
    }

    // Set interview mode (voice or text)
    function setInterviewMode(mode) {
        interviewState.interviewMode = mode;
        
        // Update mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update display
        if (mode === 'voice') {
            voiceControls.style.display = 'flex';
            textControls.style.display = 'none';
            avatarSection.style.display = 'flex';
            interviewInfo.style.display = 'block';
            initVisualizer();
        } else {
            voiceControls.style.display = 'none';
            textControls.style.display = 'block';
            avatarSection.style.display = 'none';
            interviewInfo.style.display = 'none';
        }
    }

    // Text-to-Speech function
    function speakText(text) {
        if (interviewState.interviewMode !== 'voice') return;
        
        if (interviewState.currentAudio) {
            speechSynthesis.cancel();
            interviewState.isSpeaking = false;
            interviewerAvatar.classList.remove('speaking');
        }
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        const voices = speechSynthesis.getVoices();
        const preferredVoice = voices.find(voice => 
            voice.name.includes('Google') || 
            voice.name.includes('Microsoft') || 
            voice.name.includes('Samantha') ||
            voice.name.includes('Karen') ||
            voice.name.includes('Daniel')
        );
        
        if (preferredVoice) {
            utterance.voice = preferredVoice;
        }
        
        utterance.onstart = function() {
            interviewState.isSpeaking = true;
            interviewerAvatar.classList.add('speaking');
        };
        
        utterance.onend = function() {
            interviewState.isSpeaking = false;
            interviewerAvatar.classList.remove('speaking');
        };
        
        utterance.onerror = function(event) {
            console.error('Speech synthesis error:', event);
            interviewState.isSpeaking = false;
            interviewerAvatar.classList.remove('speaking');
        };
        
        interviewState.currentAudio = utterance;
        speechSynthesis.speak(utterance);
    }

    // Speech recognition setup
    function setupSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            showError(interviewError, 'Speech recognition not supported in this browser. Please use Chrome or Edge.');
            return null;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
            interviewState.isRecording = true;
            recordBtn.classList.add('recording');
            recordBtn.innerHTML = '<span>ðŸ”´</span> Stop Recording';
            voiceStatus.textContent = 'Listening... Speak now';
            submitVoiceBtn.disabled = true;
        };

        recognition.onresult = function(event) {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }

            interviewState.currentTranscript = finalTranscript || interimTranscript;
            transcriptDisplay.textContent = interviewState.currentTranscript;
            
            // Enable submit button when we have content
            if (interviewState.currentTranscript.trim().length > 10) {
                submitVoiceBtn.disabled = false;
            }
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'not-allowed') {
                showError(interviewError, 'Microphone access denied. Please allow microphone permissions.');
            }
            stopRecording();
        };

        recognition.onend = function() {
            if (interviewState.isRecording) {
                // Auto-restart if still recording
                recognition.start();
            }
        };

        return recognition;
    }

    // Toggle recording
    async function toggleRecording() {
        if (!interviewState.isRecording) {
            try {
                // Request microphone permission
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Setup audio context for visualization
                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                source.connect(analyser);
                
                // Setup speech recognition
                interviewState.recognition = setupSpeechRecognition();
                if (interviewState.recognition) {
                    interviewState.recognition.start();
                    
                    // Start visualizer animation
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    function updateMeter() {
                        if (!interviewState.isRecording) return;
                        
                        analyser.getByteFrequencyData(dataArray);
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            sum += dataArray[i];
                        }
                        const average = sum / bufferLength;
                        updateVisualizer(average);
                        requestAnimationFrame(updateMeter);
                    }
                    updateMeter();
                }
            } catch (error) {
                console.error('Error accessing microphone:', error);
                showError(interviewError, 'Cannot access microphone. Please check permissions.');
            }
        } else {
            stopRecording();
        }
    }

    function stopRecording() {
        if (interviewState.recognition) {
            interviewState.recognition.stop();
        }
        interviewState.isRecording = false;
        recordBtn.classList.remove('recording');
        recordBtn.innerHTML = '<span>ðŸŽ¤</span> Start Recording';
        voiceStatus.textContent = 'Recording stopped. Review your transcript above.';
        
        // Reset visualizer
        initVisualizer();
    }

    // Submit voice answer
    async function submitVoiceAnswer() {
        if (!interviewState.currentTranscript.trim()) {
            showError(interviewError, 'Please record your answer first');
            return;
        }

        stopRecording();
        await submitAnswer(interviewState.currentTranscript);
        interviewState.currentTranscript = '';
        transcriptDisplay.textContent = 'Your speech will appear here...';
        submitVoiceBtn.disabled = true;
    }

    // Submit answer function (works for both text and voice)
    async function submitAnswer(answerText = null) {
        const answer = answerText || userAnswer.value.trim();
        
        if (!answer) {
            showError(interviewError, 'Please provide your response');
            return;
        }

        if (!interviewState.sessionId) {
            showError(interviewError, 'No active interview session');
            return;
        }

        addMessage(answer, 'user');
        if (!answerText) userAnswer.value = '';
        submitBtn.disabled = true;
        submitVoiceBtn.disabled = true;
        showTyping(true);

        try {
            // For demo purposes - simulate API response
            // In real implementation, replace this with actual API call
            setTimeout(() => {
                const demoQuestions = [
                    "That's a great answer! Can you tell me about a challenging project you worked on and how you overcame the obstacles?",
                    "Interesting
