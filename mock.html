<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareerCrate - Dual Mode Interview</title>
    <style>
        :root {
            --primary: #6c63ff;
            --primary-dark: #5a52d5;
            --secondary: #4a5568;
            --accent: #ff6b6b;
            --success: #10b981;
            --warning: #f59e0b;
            --dark: #1a202c;
            --light: #f7fafc;
            --white: #ffffff;
            --gray-light: #e2e8f0;
            --gray: #718096;
            --border: #cbd5e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            min-height: 100vh;
            padding-top: 80px;
        }

        /* Header - Exact Match */
        header {
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            color: var(--dark);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            height: 70px;
            width: 250px;
            display: block;
        }

        nav {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        nav a {
            color: var(--dark);
            text-decoration: none;
            font-weight: 600;
            position: relative;
            padding: 0.5rem 0;
            transition: color 0.3s;
            font-size: 0.95rem;
        }

        nav a:hover {
            color: var(--primary);
        }

        nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s;
        }

        nav a:hover::after {
            width: 100%;
        }

        .active {
            color: var(--primary);
        }

        .active::after {
            width: 100%;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid var(--gray-light);
        }

        .screen-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 2.5rem 3rem;
            text-align: center;
        }

        .screen-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .screen-header p {
            font-size: 1.2rem;
            opacity: 0.95;
            font-weight: 400;
        }

        .screen {
            padding: 3rem;
            display: none;
        }

        .active {
            display: block;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 2rem;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
        }

        input, textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: var(--white);
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 150px;
            line-height: 1.6;
        }

        .btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 99, 255, 0.3);
        }

        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Interview Screen */
       .interview-layout {
    /* Remove fixed height and use flex grow */
    height: auto;
    min-height: 600px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

        .interview-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            background: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stage-indicator {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-text {
            color: var(--gray);
            font-weight: 500;
        }

       .chat-container {
    flex: 1; /* Take available space */
    min-height: 300px; /* Minimum height */
    max-height: 400px; /* Maximum before scroll */
    padding: 1.5rem;
    overflow-y: auto;
}

        .message {
            padding: 1.5rem 2rem;
            border-radius: 16px;
            max-width: 75%;
            line-height: 1.6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .ai-message {
            background: var(--white);
            border-left: 4px solid var(--primary);
            margin-right: auto;
        }

        .user-message {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            margin-left: auto;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .interview-controls {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            background: var(--white);
        }

        .input-group {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        #userAnswer {
            flex: 1;
            resize: none;
            min-height: 100px;
            font-size: 1rem;
            line-height: 1.5;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #374151;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--dark);
        }

        .btn-outline:hover {
            background: var(--light);
            border-color: var(--primary);
        }

        .typing {
            display: none;
            color: var(--gray);
            font-style: italic;
            padding: 1.5rem;
            text-align: center;
            background: var(--light);
            margin: 1rem 2rem;
            border-radius: 10px;
            border-left: 4px solid var(--warning);
        }

        /* Feedback Screen */
        .feedback-content {
            padding: 2rem;
        }

        .feedback-summary {
            background: var(--light);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary);
        }

        .feedback-summary h3 {
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .feedback-item {
            background: var(--white);
            padding: 2.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .feedback-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding: 2rem;
        }

        /* Alerts */
        .error-message {
            background: #fef2f2;
            color: var(--accent);
            padding: 1.25rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid #fecaca;
            display: none;
            font-weight: 500;
        }

        .success-message {
            background: #f0fdf4;
            color: var(--success);
            padding: 1.25rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid #bbf7d0;
            display: none;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-bar {
            width: 200px;
            height: 6px;
            background: var(--gray-light);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
            border-radius: 3px;
        }

     .voice-controls {
    display: flex;
    flex-direction: column;
    gap: 0.5rem; /* Reduce gap */
    margin-top: 0.5rem;
}
        
        .voice-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .voice-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .voice-btn.recording {
            background: var(--accent);
            animation: pulse 1.5s infinite;
        }
        
        .voice-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }
        
        .voice-visualizer {
    height: 40px; /* Reduce from 80px */
    margin: 0.5rem 0;
    gap: 1px; /* Reduce gap between bars */
}
        
        .bar {
            width: 4px;
            background: var(--primary);
            border-radius: 2px;
            transition: height 0.1s;
        }
        
        .voice-status {
    order: -1; /* Move to top */
    text-align: center;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
}

.transcript-display {
    order: 0; /* Keep transcript next */
    min-height: 60px; /* Reduce height */
    max-height: 100px;
    margin: 0.5rem 0;
}
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .mode-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .audio-player {
            width: 100%;
            margin: 1rem 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo">
            <img src="Screenshot 2025-07-13 141234.png" alt="CareerCrate Logo" class="logo-img">
        </div>
        <nav class="navbar">
            <a href="index.html">Home</a>
            <a href="index.html#features">Features</a>
            <a href="resume.html">Resume</a>
            <a href="portfolio.html">Portfolio</a>
            <a href="internship.html">Internships</a>
            <a href="mock.html" class="active">Mock Interview</a>
            <a href="carrerpath.html">Career Suggestions</a>
            <a href="index.html#contact">Contact</a>
        </nav>
    </header>

    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen" class="screen active">
            <div class="screen-header">
                <h1>AI Mock Interview</h1>
                <p>Practice with realistic interview questions and get professional feedback</p>
            </div>
            <div style="padding: 3rem;">
                <div class="mode-toggle">
                    <button class="mode-btn active" onclick="setInterviewMode('text')">‚å®Ô∏è Text Interview</button>
                    <button class="mode-btn" onclick="setInterviewMode('voice')">üé§ Voice Interview</button>
                </div>
                
                <div class="form-group">
                    <label>Target Position</label>
                    <input type="text" id="jobRole" placeholder="e.g., Senior Frontend Developer, Data Scientist, Product Manager">
                </div>
                
                <div class="form-group">
                    <label>Professional Background & Resume</label>
                    <textarea id="resumeText" placeholder="Provide your professional experience, key projects, technical skills, and relevant background. This will be used to generate personalized interview questions."></textarea>
                </div>
                
                <button class="btn" onclick="startInterview()">Begin Interview Session</button>
                
                <div id="setupError" class="error-message"></div>
                <div id="setupSuccess" class="success-message"></div>
            </div>
        </div>
        
        <!-- Interview Screen -->
        <div id="interviewScreen" class="screen">
            <div class="screen-header">
                <h1>Mock Interview in Progress</h1>
                <p>Answer questions professionally to receive detailed feedback</p>
            </div>
            <div class="interview-layout">
                <div class="interview-header">
                    <div class="stage-indicator" id="stageIndicator">Initial Screening</div>
                    <div class="progress-container">
                        <div class="progress-text" id="progressText">Question 1 of 10</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 10%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="message ai-message">
                        <div class="message-header">Interviewer</div>
                        <div>Welcome to your mock interview session. I'll be asking questions about your background, experience, and technical expertise. Please provide detailed, professional responses as you would in an actual interview scenario.</div>
                    </div>
                </div>
                
                <div class="typing" id="typingIndicator">
                    Interviewer is preparing your next question...
                </div>
                
                <div class="interview-controls">
                    <!-- Text Input (Default) -->
                    <div class="text-controls" id="textControls">
                        <div class="input-group">
                            <textarea id="userAnswer" placeholder="Type your professional response here... (Ctrl+Enter to submit)"></textarea>
                        </div>
                        <div class="control-buttons">
                            <button class="btn" onclick="submitAnswer()" id="submitBtn">Submit Response</button>
                            <button class="btn btn-outline" onclick="askForClarification()">Request Clarification</button>
                            <button class="btn btn-outline" onclick="finishInterview()">Complete Interview</button>
                        </div>
                    </div>
                    
                    <!-- Voice Controls (Hidden by default) -->
                    <div class="voice-controls" id="voiceControls" style="display: none;">
                        <div class="voice-status" id="voiceStatus">
                            Click the microphone button to start speaking
                        </div>
                        
                        <div class="transcript-display" id="transcriptDisplay">
                            Your speech will appear here...
                        </div>
                        
                        <div class="voice-visualizer" id="voiceVisualizer">
                            <!-- Audio bars will be generated here -->
                        </div>
                        
                        <div class="control-buttons">
                            <button class="voice-btn" id="recordBtn" onclick="toggleRecording()">
                                <span>üé§</span> Start Recording
                            </button>
                            <button class="btn" onclick="submitVoiceAnswer()" id="submitVoiceBtn" disabled>
                                Submit Response
                            </button>
                            <button class="btn btn-outline" onclick="askForClarification()">
                                Request Clarification
                            </button>
                            <button class="btn btn-outline" onclick="finishInterview()">
                                Complete Interview
                            </button>
                        </div>
                    </div>
                    
                    <div id="interviewError" class="error-message"></div>
                    <div id="interviewSuccess" class="success-message"></div>
                </div>
            </div>
        </div>
        
        <!-- Feedback Screen -->
        <div id="feedbackScreen" class="screen">
            <div class="screen-header">
                <h1>Interview Performance Review</h1>
                <p>Detailed analysis of your mock interview session</p>
            </div>
            <div class="feedback-content">
                <div class="feedback-summary">
                    <h3>Session Summary</h3>
                    <p><strong>Position:</strong> <span id="feedbackJobRole">-</span></p>
                    <p><strong>Questions Completed:</strong> <span id="feedbackQuestionCount">0</span></p>
                    <p><strong>Interview Date:</strong> <span id="interviewDate">-</span></p>
                    <p><strong>Mode:</strong> <span id="interviewMode">Text</span></p>
                </div>
                
                <div id="feedbackContent">
                    <div class="typing" id="feedbackTyping">
                        Generating comprehensive performance analysis...
                    </div>
                </div>
                
                <div class="feedback-actions">
                    <button class="btn" onclick="restartInterview()">Practice Again</button>
                    <button class="btn btn-outline" onclick="showScreen('setup')">New Interview</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin.includes('5500') 
            ? 'http://localhost:3001' 
            : window.location.origin;
        
        const interviewState = {
            sessionId: null,
            questionCount: 0,
            maxQuestions: 10,
            currentStage: 'basic',
            stages: ['basic', 'role', 'technical', 'resume', 'behavioral', 'salary'],
            interviewMode: 'text', // 'voice' or 'text'
            isRecording: false,
            recognition: null,
            currentTranscript: ''
        };

        // DOM elements
        const setupScreen = document.getElementById('setupScreen');
        const interviewScreen = document.getElementById('interviewScreen');
        const feedbackScreen = document.getElementById('feedbackScreen');
        const jobRoleInput = document.getElementById('jobRole');
        const resumeTextArea = document.getElementById('resumeText');
        const chatContainer = document.getElementById('chatContainer');
        const userAnswer = document.getElementById('userAnswer');
        const submitBtn = document.getElementById('submitBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const feedbackContent = document.getElementById('feedbackContent');
        const feedbackTyping = document.getElementById('feedbackTyping');
        const stageIndicator = document.getElementById('stageIndicator');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const setupError = document.getElementById('setupError');
        const setupSuccess = document.getElementById('setupSuccess');
        const interviewError = document.getElementById('interviewError');
        const interviewSuccess = document.getElementById('interviewSuccess');
        const feedbackJobRole = document.getElementById('feedbackJobRole');
        const feedbackQuestionCount = document.getElementById('feedbackQuestionCount');
        const interviewDate = document.getElementById('interviewDate');
        const interviewMode = document.getElementById('interviewMode');
        
        // Voice elements
        const voiceControls = document.getElementById('voiceControls');
        const textControls = document.getElementById('textControls');
        const recordBtn = document.getElementById('recordBtn');
        const submitVoiceBtn = document.getElementById('submitVoiceBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const transcriptDisplay = document.getElementById('transcriptDisplay');
        const voiceVisualizer = document.getElementById('voiceVisualizer');

        const stageLabels = {
            'basic': 'Professional Background',
            'role': 'Role-specific Questions', 
            'technical': 'Technical Assessment',
            'resume': 'Experience Review',
            'behavioral': 'Behavioral Analysis',
            'salary': 'Compensation Discussion'
        };

        // Initialize audio visualizer bars
        function initVisualizer() {
            voiceVisualizer.innerHTML = '';
            for (let i = 0; i < 40; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = '2px';
                voiceVisualizer.appendChild(bar);
            }
        }

        // Update visualizer based on audio level
        function updateVisualizer(level) {
            const bars = voiceVisualizer.getElementsByClassName('bar');
            const activeBars = Math.floor((level / 100) * bars.length);
            
            for (let i = 0; i < bars.length; i++) {
                if (i < activeBars) {
                    const height = 2 + (i * 2);
                    bars[i].style.height = `${height}px`;
                    bars[i].style.background = `hsl(${210 + (i * 2)}, 100%, 50%)`;
                } else {
                    bars[i].style.height = '2px';
                    bars[i].style.background = 'var(--primary)';
                }
            }
        }

        // Set interview mode (voice or text)
        function setInterviewMode(mode) {
            interviewState.interviewMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update display
            if (mode === 'voice') {
                voiceControls.style.display = 'flex';
                textControls.style.display = 'none';
                initVisualizer();
            } else {
                voiceControls.style.display = 'none';
                textControls.style.display = 'block';
            }
        }

        // Speech recognition setup
        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showError(interviewError, 'Speech recognition not supported in this browser. Please use Chrome or Edge.');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                interviewState.isRecording = true;
                recordBtn.classList.add('recording');
                recordBtn.innerHTML = '<span>üî¥</span> Stop Recording';
                voiceStatus.textContent = 'Listening... Speak now';
                submitVoiceBtn.disabled = true;
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                interviewState.currentTranscript = finalTranscript || interimTranscript;
                transcriptDisplay.textContent = interviewState.currentTranscript;
                
                // Enable submit button when we have content
                if (interviewState.currentTranscript.trim().length > 10) {
                    submitVoiceBtn.disabled = false;
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    showError(interviewError, 'Microphone access denied. Please allow microphone permissions.');
                }
                stopRecording();
            };

            recognition.onend = function() {
                if (interviewState.isRecording) {
                    // Auto-restart if still recording
                    recognition.start();
                }
            };

            return recognition;
        }

        // Toggle recording
        async function toggleRecording() {
            if (!interviewState.isRecording) {
                try {
                    // Request microphone permission
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Setup audio context for visualization
                    const audioContext = new AudioContext();
                    const source = audioContext.createMediaStreamSource(stream);
                    const analyser = audioContext.createAnalyser();
                    source.connect(analyser);
                    
                    // Setup speech recognition
                    interviewState.recognition = setupSpeechRecognition();
                    if (interviewState.recognition) {
                        interviewState.recognition.start();
                        
                        // Start visualizer animation
                        const bufferLength = analyser.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);
                        
                        function updateMeter() {
                            if (!interviewState.isRecording) return;
                            
                            analyser.getByteFrequencyData(dataArray);
                            let sum = 0;
                            for (let i = 0; i < bufferLength; i++) {
                                sum += dataArray[i];
                            }
                            const average = sum / bufferLength;
                            updateVisualizer(average);
                            requestAnimationFrame(updateMeter);
                        }
                        updateMeter();
                    }
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    showError(interviewError, 'Cannot access microphone. Please check permissions.');
                }
            } else {
                stopRecording();
            }
        }

        function stopRecording() {
            if (interviewState.recognition) {
                interviewState.recognition.stop();
            }
            interviewState.isRecording = false;
            recordBtn.classList.remove('recording');
            recordBtn.innerHTML = '<span>üé§</span> Start Recording';
            voiceStatus.textContent = 'Recording stopped. Review your transcript above.';
            
            // Reset visualizer
            initVisualizer();
        }

        // Submit voice answer
        async function submitVoiceAnswer() {
            if (!interviewState.currentTranscript.trim()) {
                showError(interviewError, 'Please record your answer first');
                return;
            }

            stopRecording();
            await submitAnswer(interviewState.currentTranscript);
            interviewState.currentTranscript = '';
            transcriptDisplay.textContent = 'Your speech will appear here...';
            submitVoiceBtn.disabled = true;
        }

        // Modified submitAnswer to handle both text and voice
        async function submitAnswer(answerText = null) {
            const answer = answerText || userAnswer.value.trim();
            
            if (!answer) {
                showError(interviewError, 'Please provide your response');
                return;
            }

            if (!interviewState.sessionId) {
                showError(interviewError, 'No active interview session');
                return;
            }

            addMessage(answer, 'user');
            if (!answerText) userAnswer.value = '';
            submitBtn.disabled = true;
            submitVoiceBtn.disabled = true;
            showTyping(true);

            try {
                const response = await fetch(`${API_BASE_URL}/interview/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sessionId: interviewState.sessionId, 
                        answer: answer 
                    })
                });

                if (!response.ok) throw new Error('Failed to submit answer');

                const data = await response.json();

                if (data.feedback) {
                    showFeedback(data.feedback);
                    return;
                }

                if (data.question) {
                    addMessage(data.question, 'ai');
                    interviewState.questionCount = data.questionCount;
                    updateProgress();
                    updateStageIndicator(data.stage);
                }

            } catch (error) {
                showError(interviewError, 'Error submitting response');
            } finally {
                submitBtn.disabled = false;
                showTyping(false);
                if (interviewState.interviewMode === 'text') {
                    userAnswer.focus();
                }
            }
        }

        function showScreen(screen) {
            setupScreen.style.display = 'none';
            interviewScreen.style.display = 'none';
            feedbackScreen.style.display = 'none';
            
            if (screen === 'setup') setupScreen.style.display = 'block';
            else if (screen === 'interview') interviewScreen.style.display = 'block';
            else if (screen === 'feedback') feedbackScreen.style.display = 'block';
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        function showSuccess(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 3000);
        }

        function showTyping(show) {
            typingIndicator.style.display = show ? 'block' : 'none';
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            const senderName = sender === 'ai' ? 'Interviewer' : 'You';
            messageDiv.innerHTML = `
                <div class="message-header">${senderName}</div>
                <div>${text}</div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateProgress() {
            const progress = (interviewState.questionCount / interviewState.maxQuestions) * 100;
            progressText.textContent = `Question ${interviewState.questionCount} of ${interviewState.maxQuestions}`;
            progressFill.style.width = `${progress}%`;
        }

        function updateStageIndicator(stage) {
            stageIndicator.textContent = stageLabels[stage] || stage;
            interviewState.currentStage = stage;
        }

        async function startInterview() {
            const jobRole = jobRoleInput.value.trim();
            const resumeText = resumeTextArea.value.trim();
            
            if (!jobRole) {
                showError(setupError, 'Please specify the target position');
                return;
            }
            
            if (!resumeText) {
                showError(setupError, 'Please provide your professional background');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitVoiceBtn.disabled = true;
                showTyping(true);

                const response = await fetch(`${API_BASE_URL}/interview/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobRole, resumeText })
                });

                if (!response.ok) throw new Error('Failed to start interview');

                const data = await response.json();
                
                interviewState.sessionId = data.sessionId;
                interviewState.questionCount = data.questionCount;
                interviewState.maxQuestions = data.maxQuestions;

                chatContainer.innerHTML = '';
                addMessage(data.question, 'ai');
                
                updateProgress();
                updateStageIndicator(data.stage);
                showScreen('interview');

                // Initialize voice interface if in voice mode
                if (interviewState.interviewMode === 'voice') {
                    initVisualizer();
                }

            } catch (error) {
                showError(setupError, 'Error starting interview');
            } finally {
                submitBtn.disabled = false;
                showTyping(false);
                if (interviewState.interviewMode === 'text') {
                    userAnswer.focus();
                }
            }
        }

        async function askForClarification() {
            if (!interviewState.sessionId) return;

            addMessage("Could you please clarify or rephrase the question?", 'user');
            submitBtn.disabled = true;
            submitVoiceBtn.disabled = true;
            showTyping(true);

            try {
                const response = await fetch(`${API_BASE_URL}/interview/clarify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: interviewState.sessionId })
                });

                if (response.ok) {
                    const data = await response.json();
                    addMessage(data.question, 'ai');
                    showSuccess(interviewSuccess, 'Question clarified');
                }
            } catch (error) {
                showError(interviewError, 'Error requesting clarification');
            } finally {
                submitBtn.disabled = false;
                showTyping(false);
            }
        }

        async function finishInterview() {
            if (!interviewState.sessionId) {
                showScreen('setup');
                return;
            }

            showTyping(true);
            submitBtn.disabled = true;
            submitVoiceBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/interview/finish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: interviewState.sessionId })
                });

                if (response.ok) {
                    const data = await response.json();
                    showFeedback(data.feedback);
                }
            } catch (error) {
                showFeedback('Interview completed. Thank you for your participation.');
            } finally {
                showTyping(false);
                submitBtn.disabled = false;
            }
        }

        function showFeedback(feedback) {
            showScreen('feedback');
            feedbackTyping.style.display = 'none';

            feedbackJobRole.textContent = jobRoleInput.value || 'Not specified';
            feedbackQuestionCount.textContent = interviewState.questionCount;
            interviewDate.textContent = new Date().toLocaleDateString();
            interviewMode.textContent = interviewState.interviewMode === 'voice' ? 'Voice' : 'Text';
            
            const formattedFeedback = typeof feedback === 'string' 
                ? feedback.replace(/\n/g, '<br>')
                : JSON.stringify(feedback);
            
            feedbackContent.innerHTML = `
                <div class="feedback-item">
                    <div style="white-space: pre-line; line-height: 1.6;">${formattedFeedback}</div>
                </div>
            `;
        }

        function restartInterview() {
            interviewState.sessionId = null;
            interviewState.questionCount = 0;
            interviewState.currentTranscript = '';
            chatContainer.innerHTML = '';
            userAnswer.value = '';
            transcriptDisplay.textContent = 'Your speech will appear here...';
            feedbackContent.innerHTML = '';
            stopRecording();
            showScreen('interview');
        }

        // Keyboard shortcuts
        userAnswer.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                submitAnswer();
            }
        });

        // Initialize
        showScreen('setup');
        jobRoleInput.focus();
        initVisualizer();
    </script>
</body>
</html>